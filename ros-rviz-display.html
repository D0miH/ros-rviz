<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="imports.html">

<dom-module id="ros-rviz-display">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
      }
      h1 {
        @apply(--paper-font-subhead);
      }
      paper-checkbox {
        display: inline;
      }
      #header {
        cursor: pointer;
        padding: 0px 10px;
      }
      #header:hover {
        background-color: var(--paper-grey-200);
      }
      #deleteButton {
        color: var(--paper-grey-500);
      }
      #deleteButton:hover {
        color: var(--paper-red-500);
      }
      #options {
        margin: 0px 10px;
      }
    </style>
    <div class="layout horizontal" id="header" on-tap="_toggleCollapse">
      <template is="dom-if" if="{{!permanent}}">
        <paper-checkbox checked="{{isShown}}" on-tap="_handleCheckbox"><h1>{{name}}</h1></paper-checkbox>
      </template>
      <template is="dom-if" if="{{permanent}}">
        <h1>{{name}}</h1>
      </template>
      <div class="flex"></div>
      <paper-icon-button id="deleteButton" icon="cancel" on-tap="deleteDisplay" hidden$="{{permanent}}"></paper-icon-button>
    </div>
    <iron-collapse id="collapse">
      <div id="options">
        <content></content>
      </div>
    </iron-collapse>
  </template>
  <script>
    Polymer({
      is: 'ros-rviz-display',

      properties: {
        display: Object,
        name: String,
        isShown: {
          type: Boolean,
          value: true,
          observer: '_onIsShownChanged',
        },
        permanent: {
          type: Boolean,
          value: false
        },
        _viewer: Object,
        _tfClient: Object,
        _ros: Object,
        _addedToViewer: {
          type: Boolean,
          value: false,
        },
      },

      attached: function() {
        var children = this.getEffectiveChildren();
        if (children.length >= 1) {
          this.display = children[0];
          this.display.isShown = this.isShown;
          var that = this;
          this.display.addEventListener('update', function() {
            that.updateDisplay(that._viewer, that._ros, that._tfClient);
          });
          this.name = this.display.name;
        }
      },

      addToViewer: function() {
        if (!this._addedToViewer) {
          this.display.addToViewer();
          this._addedToViewer = true;
        }
      },

      deleteDisplay: function() {
        this.display.removeFromViewer();
        this.display.deleteDisplay();
        this.parentNode.removeChild(this);
      },

      removeFromViewer: function() {
        if (this._addedToViewer) {
          this.display.removeFromViewer();
          this._addedToViewer = false;
        }
      },

      updateDisplay: function(viewer, ros, tfClient) {
        if (this.isShown && !this._addedToViewer) {
          this.addToViewer();
        }
        this._viewer = viewer;
        this._ros = ros;
        this._tfClient = tfClient;
        if (this.isShown) {
          this.removeFromViewer();
        }
        var that = this;
        this.display.updateDisplay(viewer, ros, tfClient, function() {
          if (that.isShown) {
            that.addToViewer();
          }
        });
      },

      updateGlobalOptions: function(globalOptions) {
        this.globalOptions = globalOptions;
        if (this.display.updateGlobalOptions) {
          this.display.updateGlobalOptions(this.globalOptions);
        }
      },

      _handleCheckbox: function(evt) {
        evt.stopPropagation();
      },

      _onIsShownChanged: function() {
        if (this.display) {
          this.display.isShown = this.isShown;
        }
        if (this.isShown && !this._addedToViewer && this.display) {
          this.display.addToViewer();
          this._addedToViewer = true;
        } else if (!this.isShown && this._addedToViewer && this.display) {
          this.display.removeFromViewer();
          this._addedToViewer = false;
        }
      },

      _toggleCollapse: function() {
        this.$.collapse.toggle();
      }
    });
  </script>
</dom-module>
