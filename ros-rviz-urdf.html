<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="imports.html">

<dom-module id="ros-rviz-urdf">
  <template>
    <paper-input label="Robot description topic" value="{{param}}"></paper-input>
    <paper-input label="Collada file server" value="{{colladaFileServer}}"></paper-input>
  </template>
  <script>
    Polymer({
      is: 'ros-rviz-urdf',

      properties: {
        name: {
          type: String,
          value: 'Robot model',
        },
        param: {
          type: String,
          value: 'robot_description'
        },
        colladaFileServer: {
          type: String,
          value: 'http://resources.robotwebtools.org/'
        },
        _urdf: Object,
        _viewer: Object,
        _tfClient: Object,
        _ros: Object,
      },

      observers: [
        '_onOptionsChanged(param, colladaFileServer)',
      ],

      addToViewer: function() {
        if (this._viewer) {
          this._viewer.addObject(this._urdf);
        }
      },

      deleteDisplay: function() {
        // Nothing to delete.
      },

      updateDisplay: function(viewer, ros, tfClient, callback) {
        if (!viewer || !ros || !tfClient) {
          return;
        }
        this._viewer = viewer;
        this._ros = ros;
        this._tfClient = tfClient;
        var that = this;
        var getParam = new ROSLIB.Param({
          ros: ros,
          name: that.param
        });
        getParam.get(function(string) {
          var urdfModel = new ROSLIB.UrdfModel({
            string: string
          });
          var loader = ROS3D.COLLADA_LOADER_2;
          that._urdf = new ROS3D.Urdf({
            urdfModel: urdfModel,
            path: that.colladaFileServer,
            tfClient: tfClient,
            tfPrefix: '',
            loader: loader
          });
          callback && callback();
        });
      },

      removeFromViewer: function() {
        if (this._viewer) {
          this._viewer.scene.remove(this._urdf);
        }
      },

      _onOptionsChanged: function(param, colladaFileServer) {
        this.fire('update');
      },
    });
  </script>
</dom-module>
